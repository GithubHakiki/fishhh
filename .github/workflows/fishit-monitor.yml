name: Fish-It Event Monitor

on:
  schedule:
    - cron: '*/10 * * * *' # Every 10 minutes
  workflow_dispatch: # Manual trigger

jobs:
  check-event:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Puppeteer
        run: npm install puppeteer
      
      - name: Check for Fish-It Events
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          (async () => {
            console.log('Launching browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const page = await browser.newPage();
            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
            
            console.log('Navigating to Fish-It page...');
            await page.goto('https://www.roblox.com/games/121864768012064/Fish-It', {
              waitUntil: 'networkidle2',
              timeout: 30000
            });
            
            // Wait for event tiles to load
            await page.waitForSelector('.experience-events-tile', { timeout: 5000 }).catch(() => {
              console.log('No event tiles found');
            });
            
            // Extract event data with more details
            const events = await page.evaluate(() => {
              const tiles = document.querySelectorAll('.experience-events-tile');
              return Array.from(tiles).map(tile => {
                const titleElement = tile.querySelector('.game-card-name');
                const dateElement = tile.querySelector('.game-card-info');
                const imageElement = tile.querySelector('img');
                const linkElement = tile.querySelector('a');
                const descriptionElement = tile.querySelector('.info-label');
                
                return {
                  id: tile.id,
                  title: titleElement?.textContent?.trim() || 'Unknown Event',
                  date: dateElement?.textContent?.trim() || '',
                  image: imageElement?.src || '',
                  link: linkElement?.href || '',
                  description: descriptionElement?.textContent?.trim() || ''
                };
              });
            });
            
            console.log(`Found ${events.length} event(s)`);
            
            await browser.close();
            
            if (events.length === 0) {
              console.log('No events found');
              process.exit(0);
            }
            
            const currentEvent = events[0];
            console.log('Current event:', JSON.stringify(currentEvent, null, 2));
            
            // Read last event ID
            let lastEventId = '';
            try {
              lastEventId = fs.readFileSync('last_event_id.txt', 'utf8').trim();
            } catch (e) {
              console.log('No previous event ID found');
            }
            
            if (currentEvent.id === lastEventId) {
              console.log('Event unchanged');
              process.exit(0);
            }
            
            // Save new event ID
            fs.writeFileSync('last_event_id.txt', currentEvent.id);
            
            // Send to Discord
            const discordWebhook = process.env.DISCORD_WEBHOOK;
            if (!discordWebhook) {
              console.error('DISCORD_WEBHOOK not set');
              process.exit(1);
            }
            
            const isNewEvent = !!lastEventId;
            const message = isNewEvent ? 'üö® **EVENT BARU TERDETEKSI!**' : 'üé£ Event aktif terdeteksi';
            
            // Parse date if available
            let timestamp = new Date().toISOString();
            let formattedDate = currentEvent.date;
            
            // Try to parse the date string (e.g., "Sun, Feb 1, 8:00 AM")
            if (currentEvent.date) {
              try {
                // This is a simple parse - adjust if needed based on actual date format
                const dateMatch = currentEvent.date.match(/(\w+),\s+(\w+)\s+(\d+),\s+(\d+):(\d+)\s+(AM|PM)/);
                if (dateMatch) {
                  formattedDate = `üìÖ ${currentEvent.date}`;
                }
              } catch (e) {
                console.log('Could not parse date');
              }
            }
            
            const embed = {
              title: 'üé£ Fish-It Event Alert',
              description: message,
              url: currentEvent.link || `https://www.roblox.com/events/${currentEvent.id}`,
              color: 0xFF6600, // Orange
              thumbnail: {
                url: currentEvent.image || 'https://tr.rbxcdn.com/180DAY-a9ff09dd1042a26b4364f92a4324ad2a/384/216/Image/Jpeg/noFilter'
              },
              fields: [
                {
                  name: 'üìå Event Name',
                  value: currentEvent.title || 'Unknown Event',
                  inline: false
                }
              ],
              timestamp: timestamp,
              footer: {
                text: 'Fish-It Event Watcher'
              }
            };
            
            // Add date field if available
            if (formattedDate) {
              embed.fields.push({
                name: 'üïê Event Time',
                value: formattedDate,
                inline: false
              });
            }
            
            // Add description if available
            if (currentEvent.description) {
              embed.fields.push({
                name: 'üìù Details',
                value: currentEvent.description,
                inline: false
              });
            }
            
            // Add event ID
            embed.fields.push({
              name: 'üîñ Event ID',
              value: `\`${currentEvent.id}\``,
              inline: true
            });
            
            // Add link
            embed.fields.push({
              name: 'üîó Link',
              value: `[Open Event](https://www.roblox.com/events/${currentEvent.id})`,
              inline: true
            });
            
            const response = await fetch(discordWebhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                content: isNewEvent ? '@everyone' : null,
                embeds: [embed]
              })
            });
            
            if (response.ok) {
              console.log('‚úÖ Discord notification sent!');
            } else {
              const errorText = await response.text();
              console.error('‚ùå Failed to send Discord notification:', response.status, errorText);
              process.exit(1);
            }
          })();
          EOF
      
      - name: Commit event ID
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add last_event_id.txt || true
          git commit -m "Update event ID [skip ci]" || true
          git push || true
