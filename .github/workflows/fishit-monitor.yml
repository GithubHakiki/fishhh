name: Fish-It Event Monitor

on:
  schedule:
    - cron: '*/10 * * * *' # Every 10 minutes
  workflow_dispatch: # Manual trigger

jobs:
  check-event:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Puppeteer
        run: npm install puppeteer
      
      - name: Check for Fish-It Events
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          (async () => {
            console.log('Launching browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const page = await browser.newPage();
            
            // Set timezone to WIB (Asia/Jakarta) so Roblox shows correct time
            await page.emulateTimezone('Asia/Jakarta');
            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
            
            console.log('Navigating to Fish-It page...');
            await page.goto('https://www.roblox.com/games/121864768012064/Fish-It', {
              waitUntil: 'networkidle2',
              timeout: 30000
            });
            
            // Wait for event tiles to load
            await page.waitForSelector('.experience-events-tile', { timeout: 5000 }).catch(() => {
              console.log('No event tiles found');
            });
            
            // Extract event data with more details
            const events = await page.evaluate(() => {
              const tiles = document.querySelectorAll('.experience-events-tile');
              return Array.from(tiles).map(tile => {
                const titleElement = tile.querySelector('.game-card-name');
                const dateElement = tile.querySelector('.game-card-info');
                const imageElement = tile.querySelector('img');
                const linkElement = tile.querySelector('a');
                const descriptionElement = tile.querySelector('.info-label');
                
                // Get raw date text
                const rawDate = dateElement?.textContent?.trim() || '';
                
                // Check if event is live now (case insensitive, handle variations)
                const lowerDate = rawDate.toLowerCase();
                const isLiveNow = lowerDate === 'new content' || 
                                 lowerDate === 'newcontent' || 
                                 lowerDate.includes('new content');
                
                return {
                  id: tile.id,
                  title: titleElement?.textContent?.trim() || 'Unknown Event',
                  date: rawDate,
                  isLiveNow: isLiveNow, // Detect if event is live NOW
                  image: imageElement?.src || '',
                  link: linkElement?.href || '',
                  description: descriptionElement?.textContent?.trim() || ''
                };
              });
            });
            
            console.log(`Found ${events.length} event(s)`);
            
            await browser.close();
            
            if (events.length === 0) {
              console.log('No events found');
              process.exit(0);
            }
            
            const currentEvent = events[0];
            console.log('Current event:', JSON.stringify(currentEvent, null, 2));
            
            // Read last event ID and notification status
            let lastEventId = '';
            let wasNotified = false;
            
            try {
              const savedData = fs.readFileSync('last_event_id.txt', 'utf8').trim();
              if (savedData.includes('|')) {
                // Format: "eventId|notified"
                const [id, notifStatus] = savedData.split('|');
                lastEventId = id;
                wasNotified = notifStatus === 'true';
              } else {
                // Old format: just event ID
                lastEventId = savedData;
                wasNotified = false;
              }
            } catch (e) {
              console.log('No previous event ID found');
            }
            
            console.log(`Last event: ${lastEventId}, Was notified: ${wasNotified}`);
            
            // Check if event ID is the same
            if (currentEvent.id === lastEventId) {
              if (wasNotified) {
                console.log('Event unchanged and already notified - skipping');
                process.exit(0);
              } else {
                console.log('Event unchanged but not yet notified - will send notification');
              }
            } else {
              console.log('New event detected!');
            }
            
            // Save event ID with notified status AFTER sending notification
            const saveEventData = (notified) => {
              fs.writeFileSync('last_event_id.txt', `${currentEvent.id}|${notified}`);
            };
            
            // Send to Discord
            const discordWebhook = process.env.DISCORD_WEBHOOK;
            if (!discordWebhook) {
              console.error('DISCORD_WEBHOOK not set');
              process.exit(1);
            }
            
            // Parse date and convert to Unix timestamp for Discord
            let discordTimestamp = null;
            let eventTimeDisplay = '';
            
            if (currentEvent.isLiveNow) {
              // Event is happening NOW!
              discordTimestamp = Math.floor(Date.now() / 1000);
              eventTimeDisplay = 'üî¥ **LIVE NOW! Event sedang berjalan sekarang!**';
              console.log('Event is LIVE NOW!');
            } else if (currentEvent.date) {
              try {
                // Parse date like "Sun, Feb 1, 8:00 AM" (WIB time from Puppeteer with Asia/Jakarta timezone)
                const dateMatch = currentEvent.date.match(/(\w+),\s+(\w+)\s+(\d+),\s+(\d+):(\d+)\s+(AM|PM)/);
                if (dateMatch) {
                  const [_, dayName, month, day, hour, minute, ampm] = dateMatch;
                  
                  // Convert to 24-hour format
                  let hour24 = parseInt(hour);
                  if (ampm === 'PM' && hour24 !== 12) hour24 += 12;
                  if (ampm === 'AM' && hour24 === 12) hour24 = 0;
                  
                  // Month mapping
                  const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                  };
                  
                  // Create date object in WIB (UTC+7)
                  const year = new Date().getFullYear();
                  const dateObj = new Date(Date.UTC(
                    year, 
                    monthMap[month], 
                    parseInt(day), 
                    hour24 - 7, // Convert WIB to UTC by subtracting 7 hours
                    parseInt(minute)
                  ));
                  
                  // Get Unix timestamp (seconds)
                  discordTimestamp = Math.floor(dateObj.getTime() / 1000);
                  eventTimeDisplay = `<t:${discordTimestamp}:F>`;
                  
                  console.log(`Parsed date: ${currentEvent.date} (WIB) -> Unix: ${discordTimestamp}`);
                }
              } catch (e) {
                console.log('Could not parse date:', e.message);
                eventTimeDisplay = `üìÖ ${currentEvent.date}`;
              }
            }
            
            const embed = {
              title: currentEvent.isLiveNow ? 'üî¥ Fish-It Event LIVE NOW!' : 'üé£ Fish-It Event Alert',
              description: currentEvent.isLiveNow ? 'üö® **EVENT SEDANG BERJALAN SEKARANG!**' : 'üö® **EVENT BARU TERDETEKSI!**',
              url: currentEvent.link || `https://www.roblox.com/events/${currentEvent.id}`,
              color: currentEvent.isLiveNow ? 0xFF0000 : 0xFF6600, // Red for live, Orange for scheduled
              thumbnail: {
                url: currentEvent.image || 'https://tr.rbxcdn.com/180DAY-a9ff09dd1042a26b4364f92a4324ad2a/384/216/Image/Jpeg/noFilter'
              },
              fields: [
                {
                  name: 'üìå Event Name',
                  value: currentEvent.title || 'Unknown Event',
                  inline: false
                }
              ],
              timestamp: new Date().toISOString(),
              footer: {
                text: 'Fish-It Event Watcher'
              }
            };
            
            // Add date field with Discord timestamp (auto-converts to user's timezone)
            if (eventTimeDisplay) {
              embed.fields.push({
                name: currentEvent.isLiveNow ? '‚è∞ Status' : 'üïê Event Time',
                value: eventTimeDisplay,
                inline: false
              });
            }
            
            // Add description if available
            if (currentEvent.description) {
              embed.fields.push({
                name: 'üìù Details',
                value: currentEvent.description,
                inline: false
              });
            }
            
            // Add event ID
            embed.fields.push({
              name: 'üîñ Event ID',
              value: `\`${currentEvent.id}\``,
              inline: true
            });
            
            // Add link
            embed.fields.push({
              name: 'üîó Link',
              value: `[Open Event](https://www.roblox.com/events/${currentEvent.id})`,
              inline: true
            });
            
            const response = await fetch(discordWebhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                content: '@everyone',
                embeds: [embed]
              })
            });
            
            if (response.ok) {
              console.log('‚úÖ Discord notification sent!');
              // Save event ID with notified=true
              saveEventData(true);
            } else {
              const errorText = await response.text();
              console.error('‚ùå Failed to send Discord notification:', response.status, errorText);
              // Save event ID with notified=false so it will retry next time
              saveEventData(false);
              process.exit(1);
            }
          })();
          EOF
      
      - name: Commit event ID
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add last_event_id.txt || true
          git commit -m "Update event ID [skip ci]" || true
          git push || true
